<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Metadatos -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movilidad ‚Äì SITP en Barrio Mar√≠a Cano (Bogot√° D.C.)</title>

  <!-- Estilos propios -->
  <link rel="stylesheet" href="src/css/styles_movilidad.css" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster (para paraderos/estaciones) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script defer src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Turf.js para operaciones espaciales -->
  <script defer src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
</head>
<body class="movilidad">
  <!-- ==================== FILA 1: Encabezado ==================== -->
  <header class="topbar">
    <div class="logo-title">
      <a href="./">
        <img
          src="https://uploads.knightlab.com/storymapjs/7f1f7a40dec75712842017c6dcdce290/ruta-de-maria-cano/_images/mariacano.png"
          alt="Logo Barrio Mar√≠a Cano"
          class="logo"
          loading="lazy"
        />
      </a>
      <h1 class="title">SITP ‚Äì Barrio Mar√≠a Cano ¬∑ Bogot√° D.C.</h1>
    </div>
  </header>

  <!-- ==================== FILA 2: Navegaci√≥n ==================== -->
  <nav class="navgrid" role="navigation" aria-label="Navegaci√≥n principal">
    <div class="navitem dropdown">
      <button class="dropbtn" aria-haspopup="true" aria-expanded="false">
        Equipamiento <span class="caret" aria-hidden="true">‚ñæ</span>
      </button>
      <ul class="dropdown-menu" role="menu" aria-label="Submen√∫ de Equipamiento">
        <li role="none"><a role="menuitem" href="ubicacion.html">Ubicaci√≥n</a></li>
        <li role="none"><a role="menuitem" href="movilidad.html" aria-current="page">Movilidad</a></li>
        <li role="none"><a role="menuitem" href="troncales.html">Troncales</a></li>
        <li role="none"><a role="menuitem" href="parques.html">Parques</a></li>
        <li role="none"><a role="menuitem" href="vias.html">V√≠as</a></li>
        <li role="none"><a role="menuitem" href="catastro3d.html">Catastros 3D</a></li>
      </ul>
    </div>

    <a class="navitem" href="problemas.html" title="Ir a Problemas">Problemas</a>
    <a class="navitem acerca" href="acerca.html" title="Ir a Acerca de">
      Acerca de
      <img
        src="https://previews.123rf.com/images/valentint/valentint1704/valentint170400665/75401422-about-us-icon-about-us-website-button-on-white-background.jpg"
        alt="Logo Acerca de"
        class="acerca-logo"
        loading="lazy"
      />
    </a>
  </nav>

  <!-- ==================== FILA 3: Mapa + Panel ==================== -->
  <main class="layout">
    <section id="map" aria-label="Mapa de movilidad SITP"></section>

    <aside id="panel" aria-live="polite">
      <div class="panel-header">
        <strong>Estado de intersecci√≥n</strong>
        <span class="pill">Datos: <code>.geojson</code></span>
      </div>

      <div class="msg">
        Esta p√°gina visualiza las rutas del SITP en Bogot√° y resalta aquellas que se intersectan con el barrio <b>Mar√≠a Cano</b>. Si hay rutas o paraderos dentro del barrio, se listan aqu√≠; de lo contrario, ver√°s el mensaje correspondiente.
      </div>

      <div id="resumen" class="msg">Cargando capas‚Ä¶</div>

      <div class="legend">
        <div class="chip"><span class="swatch sw-barrio"></span> Barrio Mar√≠a Cano</div>
        <div class="chip"><span class="swatch sw-base-route"></span> Rutas SITP (todas)</div>
        <div class="chip"><span class="swatch sw-base-stop"></span> Paraderos/Estaciones SITP (todos)</div>
        <div class="chip"><span class="swatch sw-hit"></span> Elementos dentro del barrio</div>
      </div>

      <div class="actions">
        <button class="btn" id="btn-zoom-barrio">Enfocar barrio</button>
        <button class="btn" id="btn-ver-intersectan">Ver intersecciones</button>
        <button class="btn" id="btn-ver-todo">Ver todo</button>
      </div>
    </aside>
  </main>

  <!-- ==================== JS ==================== -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ----------- Rutas de datos locales (ajusta nombres si difieren) -----------
    const SRC = "src/assets/";
    const FILES = {
      barrios    : SRC + "barrios.geojson",
      rutasSITP  : SRC + "Lineas_Estaciones_SITP.geojson",      // l√≠neas SITP (LineString/MultiLineString) con cod_linea, nom_ruta, orig_ruta, dest_ruta
      paraderos  : SRC + "paraderos_zonalesSITP.geojson"        // puntos de paraderos/estaciones
    };

    // ----------- Utilidades -----------
    const cssVar = v => getComputedStyle(document.documentElement).getPropertyValue(v).trim();
    const isMariaCano = (name) => {
      const n = String(name||"")
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/\s+/g," ").trim().toLowerCase();
      return n.includes("maria cano"); // tolera variantes de escritura
    };

    // ----------- Mapa base -----------
    const map = L.map("map", { zoomControl: true });
    const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 20, attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    // √çcono tipo bus para estaciones/paraderos (sin depender de im√°genes externas)
    const busIcon = L.divIcon({
      className: "bus-icon",
      html: '<div class="bus-pin" aria-hidden="true">üöå</div>',
      iconSize: [28, 28],
      iconAnchor: [14, 28],
      popupAnchor: [0, -28]
    });

    // Capas
    const layerBarrio = L.geoJSON(null, {
      style: { color: cssVar("--accent2") || "#FF7043", weight: 2.5, fillOpacity: 0.08 }
    }).addTo(map);

    // RUTAS (todas) en morado; se agregan tooltips de l√≠neas v√≠a onEachFeature
    const layerRutasAll = L.geoJSON(null, {
      style: () => ({ color: cssVar("--baseRoute") || "#3e085e", weight: 2 }),
      onEachFeature: (f, l) => {
        const p = f.properties || {};
        const cod = p.cod_linea || p.COD_LINEA || p.codigo || "";
        const nom = p.nom_ruta  || p.NOM_RUTA  || p.nombre || p.NOMBRE || "Ruta SITP";
        const ori = p.orig_ruta || p.ORIG_RUTA || p.origen || "";
        const des = p.dest_ruta || p.DEST_RUTA || p.destino || "";
        const tip = `
          <div class="tip">
            <b>${nom}${cod ? " ("+cod+")" : ""}</b><br/>
            <small>Origen:</small> ${ori || "‚Äî"}<br/>
            <small>Destino:</small> ${des || "‚Äî"}
          </div>
        `;
        l.bindTooltip(tip, { sticky:true, direction:"top", opacity:0.95 });

        // resaltado en hover
        l.on("mouseover", () => l.setStyle({ weight: 5, opacity: 1 }));
        l.on("mouseout",  () => l.setStyle({ weight: 2, opacity: 1 }));
      }
    }).addTo(map);

    // Cl√∫ster de estaciones/paraderos (todos)
    const clusterParaderosAll = L.markerClusterGroup({ disableClusteringAtZoom: 17 });

    // Capa de estaciones/paraderos con icono bus y tooltip en hover
    const layerParaderosAll = L.geoJSON(null, {
      pointToLayer: (f, latlng) => L.marker(latlng, { icon: busIcon }),
      onEachFeature: (f, l) => {
        const p  = f.properties || {};
        const nom = p.nombre || p.NOMBRE || p.name || "Estaci√≥n/Paradero";
        const via = p.via    || p.VIA    || p.calle || p.CALLE || "";
        const dir = p.direccion_bandera || p.DIRECCION_BANDERA || p.dir_bandera || "";
        const tip = `
          <div class="tip">
            <b>${nom}</b><br/>
            <small>V√≠a:</small> ${via || "‚Äî"}<br/>
            <small>Direcci√≥n bandera:</small> ${dir || "‚Äî"}
          </div>
        `;
        l.bindTooltip(tip, { sticky:true, direction:"top", opacity:0.95 });
        l.on("mouseover", () => l.getElement()?.classList.add("hover"));
        l.on("mouseout",  () => l.getElement()?.classList.remove("hover"));
      }
    });

    // A√±adir cada marcador al cluster
    layerParaderosAll.on("layeradd", (e) => {
      if (e.layer && e.layer.getLatLng) clusterParaderosAll.addLayer(e.layer);
    });

    // Capas destacadas (intersecci√≥n con el barrio)
    const layerRutasHit = L.geoJSON(null, {
      style: { color: cssVar("--accent") || "#4FC3F7", weight: 3.5 },
      onEachFeature: (f, l) => {
        const p = f.properties || {};
        const cod = p.cod_linea || p.COD_LINEA || p.codigo || "";
        const nom = p.nom_ruta  || p.NOM_RUTA  || p.nombre || p.NOMBRE || "Ruta SITP";
        const ori = p.orig_ruta || p.ORIG_RUTA || p.origen || "";
        const des = p.dest_ruta || p.DEST_RUTA || p.destino || "";
        const tip = `
          <div class="tip">
            <b>${nom}${cod ? " ("+cod+")" : ""}</b><br/>
            <small>Origen:</small> ${ori || "‚Äî"}<br/>
            <small>Destino:</small> ${des || "‚Äî"}
          </div>
        `;
        l.bindTooltip(tip, { sticky:true, direction:"top", opacity:0.95 });
        l.on("mouseover", () => l.setStyle({ weight: 5 }));
        l.on("mouseout",  () => l.setStyle({ weight: 3.5 }));
      }
    });

    const layerParaderosHit = L.geoJSON(null, {
      pointToLayer: (f, latlng) => L.marker(latlng, { icon: busIcon }),
      onEachFeature: (f, l) => {
        const p  = f.properties || {};
        const nom = p.nombre || p.NOMBRE || p.name || "Estaci√≥n/Paradero";
        const via = p.via    || p.VIA    || p.calle || p.CALLE || "";
        const dir = p.direccion_bandera || p.DIRECCION_BANDERA || p.dir_bandera || "";
        const tip = `
          <div class="tip">
            <b>${nom}</b><br/>
            <small>V√≠a:</small> ${via || "‚Äî"}<br/>
            <small>Direcci√≥n bandera:</small> ${dir || "‚Äî"}
          </div>
        `;
        l.bindTooltip(tip, { sticky:true, direction:"top", opacity:0.95 });
      }
    });

    // ----------- Carga y l√≥gica principal -----------
    Promise.all([
      fetch(FILES.barrios).then(r=> r.ok ? r.json() : Promise.reject(new Error("No se pudo leer barrios.geojson"))),
      fetch(FILES.rutasSITP).then(r=> r.ok ? r.json() : Promise.reject(new Error("No se pudo leer Lineas_Estaciones_SITP.geojson"))),
      fetch(FILES.paraderos).then(r=> r.ok ? r.json() : Promise.reject(new Error("No se pudo leer paraderos_zonalesSITP.geojson")))
    ]).then(([barrios, rutas, paraderos]) => {
      // 1) Encontrar Mar√≠a Cano por varias claves posibles
      const featsBarrio = (barrios.features || []).filter(f => {
        const props = f.properties || {};
        const name = props.barriocomu || props.BARRIO || props.Nombre || props.NOMBRE || props.name;
        return isMariaCano(name);
      });

      if (!featsBarrio.length) {
        document.getElementById("resumen").innerHTML =
          `<span class="error">No se encontr√≥ el pol√≠gono del barrio ‚ÄúMar√≠a Cano‚Äù.</span><br>
           Verifica que <code>barrios.geojson</code> tenga la propiedad <code>barriocomu</code> (o similar) con ese valor.`;
        map.setView([4.711, -74.072], 11); // Bogot√° como referencia
        // Mostrar totales de referencia
        layerRutasAll.addData(rutas);
        layerParaderosAll.addData(paraderos);
        map.addLayer(clusterParaderosAll);
        return;
      }

      const barrio = featsBarrio[0];
      layerBarrio.addData(barrio);

      // Centrar mapa en el barrio
      const bbox = turf.bbox(barrio);
      map.fitBounds([[bbox[1], bbox[0]], [bbox[3], bbox[2]]], { padding:[20,20] });

      // 2) Pintar totales
      layerRutasAll.addData(rutas);
      layerParaderosAll.addData(paraderos);
      map.addLayer(clusterParaderosAll);

      // 3) Intersecciones
      const rutasHits = (rutas.features || []).filter(f => {
        try { return f.geometry && turf.booleanIntersects(f, barrio); }
        catch(e) { return false; }
      });

      let paraderosHits = [];
      try {
        const ptsFC = { type:"FeatureCollection", features: (paraderos.features || []) };
        const dentro = turf.pointsWithinPolygon(ptsFC, barrio);
        paraderosHits = dentro.features || [];
      } catch(e) { paraderosHits = []; }

      layerRutasHit.addData({ type:"FeatureCollection", features: rutasHits });
      layerParaderosHit.addData({ type:"FeatureCollection", features: paraderosHits });

      // 4) Panel resumen
      const rN = rutas.features?.length ?? 0;
      const pN = paraderos.features?.length ?? 0;
      const rH = rutasHits.length;
      const pH = paraderosHits.length;

      const resumen = document.getElementById("resumen");
      if (rH===0 && pH===0){
        resumen.innerHTML =
          `<div class="warn">El barrio Mar√≠a Cano no cuenta con rutas ni paraderos del SITP.</div>
           <div class="msg">Se muestran <span class="count">${rN}</span> rutas y <span class="count">${pN}</span> paraderos totales como referencia.</div>`;
      } else {
        resumen.innerHTML =
          `<div>Intersecciones encontradas:</div>
           <ul class="list">
             <li>Rutas dentro del barrio: <span class="count ok">${rH}</span> / ${rN}</li>
             <li>Paraderos dentro del barrio: <span class="count ok">${pH}</span> / ${pN}</li>
           </ul>
           <div class="msg msg-compact">Usa los botones para resaltar solo lo que intersecta.</div>`;
        layerRutasHit.addTo(map);
        layerParaderosHit.addTo(map);
      }

      // 5) Botones
      document.getElementById("btn-zoom-barrio").onclick = () => {
        const b = turf.bbox(barrio);
        map.fitBounds([[b[1], b[0]], [b[3], b[2]]], { padding:[20,20] });
      };
      document.getElementById("btn-ver-intersectan").onclick = () => {
        map.addLayer(layerRutasHit);
        map.addLayer(layerParaderosHit);
      };
      document.getElementById("btn-ver-todo").onclick = () => {
        map.removeLayer(layerRutasHit);
        map.removeLayer(layerParaderosHit);
      };

      // 6) Control de capas
      const overlays = {
        "Barrio Mar√≠a Cano": layerBarrio,
        "Rutas SITP (todas)": layerRutasAll,
        "Paraderos SITP (todos)": clusterParaderosAll,
        "Rutas dentro del barrio": layerRutasHit,
        "Paraderos dentro del barrio": layerParaderosHit
      };
      L.control.layers({ "OpenStreetMap": osm }, overlays, { collapsed:true }).addTo(map);

    }).catch(err=>{
      console.error(err);
      document.getElementById("resumen").innerHTML =
        `<span class="error">Error cargando archivos GeoJSON. Revisa rutas en <code>src/assets/</code>.</span><br><small>${err.message}</small>`;
      map.setView([4.711, -74.072], 11);
    });

    // Dropdown accesible para m√≥vil/t√°ctil
    const btn = document.querySelector('.dropbtn');
    if (btn) {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const dd = btn.closest('.dropdown');
        const expanded = btn.getAttribute('aria-expanded') === 'true';
        btn.setAttribute('aria-expanded', String(!expanded));
        dd.classList.toggle('open');
      });
    }
  });
  </script>
</body>
</html>
