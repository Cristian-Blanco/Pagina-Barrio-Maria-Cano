<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Metadatos -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barrio María Cano – Bogotá D.C.</title>

  <!-- Estilos propios -->
  <link rel="stylesheet" href="src/css/styles_movilidad.css" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster (para paraderos, opcional) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script defer src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Turf.js para operaciones espaciales -->
  <script defer src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
</head>
<body class="movilidad">
  <!-- ==================== FILA 1: Encabezado con logo + título ==================== -->
  <header class="topbar">
    <div class="logo-title">
      <img
        src="https://uploads.knightlab.com/storymapjs/7f1f7a40dec75712842017c6dcdce290/ruta-de-maria-cano/_images/mariacano.png"
        alt="Logo Barrio María Cano"
        class="logo"
        loading="lazy"
      />
      <h1 class="title">Barrio María Cano – Bogotá D.C. – Colombia</h1>
    </div>
  </header>

  <!-- ==================== FILA 2: Navegación principal ==================== -->
  <nav class="navgrid" role="navigation" aria-label="Navegación principal">
    <div class="navitem dropdown">
      <button class="dropbtn" aria-haspopup="true" aria-expanded="false">
        Equipamiento <span class="caret" aria-hidden="true">▾</span>
      </button>
      <ul class="dropdown-menu" role="menu" aria-label="Submenú de Equipamiento">
        <li role="none"><a role="menuitem" href="ubicacion.html">Ubicación</a></li>
        <li role="none"><a role="menuitem" href="movilidad.html">Movilidad</a></li>
        <li role="none"><a role="menuitem" href="troncales.html">Troncales</a></li>
        <li role="none"><a role="menuitem" href="parques.html">Parques</a></li>
        <li role="none"><a role="menuitem" href="vias.html">Vías</a></li>
        <li role="none"><a role="menuitem" href="catastro3d.html">Catastros 3D</a></li>
        <li role="none"><a role="menuitem" href="recorrido-virtual.html">Recorrido Virtual</a></li>
      </ul>
    </div>

    <a class="navitem" href="problemas.html" title="Ir a Problemas">Problemas</a>
    <a class="navitem acerca" href="acerca.html" title="Ir a Acerca de">
      Acerca de
      <img
        src="https://previews.123rf.com/images/valentint/valentint1704/valentint170400665/75401422-about-us-icon-about-us-website-button-on-white-background.jpg"
        alt="Logo Acerca de"
        class="acerca-logo"
        loading="lazy"
      />
    </a>
  </nav>

  <!-- ==================== FILA 3: Mapa + Panel ==================== -->
  <main class="layout">
    <section id="map" aria-label="Mapa de movilidad SITP"></section>

    <aside id="panel" aria-live="polite">
      <div class="panel-header">
        <strong>Estado de intersección</strong>
        <span class="pill">Datos: <code>.geojson</code></span>
      </div>

      <div id="resumen" class="msg">Cargando capas…</div>

      <div class="legend">
        <div class="chip"><span class="swatch sw-barrio"></span> Barrio María Cano</div>
        <div class="chip"><span class="swatch sw-base-route"></span> Rutas SITP (todas)</div>
        <div class="chip"><span class="swatch sw-base-stop"></span> Paraderos SITP (todos)</div>
        <div class="chip"><span class="swatch sw-hit"></span> Elementos dentro del barrio</div>
      </div>

      <div class="actions">
        <button class="btn" id="btn-zoom-barrio">Enfocar barrio</button>
        <button class="btn" id="btn-ver-intersectan">Ver intersecciones</button>
        <button class="btn" id="btn-ver-todo">Ver todo</button>
      </div>
    </aside>
  </main>

  <!-- ==================== JS ==================== -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ----------- Rutas de datos locales -----------
    const SRC = "src/assets/";
    const FILES = {
      barrios   : SRC + "barrios.geojson",
      rutasSITP : SRC + "Lineas_Estaciones_SITP.geojson",
      paraderos : SRC + "paraderos_zonalesSITP.geojson"
    };

    // ----------- Utilidades -----------
    const cssVar = v => getComputedStyle(document.documentElement).getPropertyValue(v).trim();
    const isMariaCano = (name) => {
      const n = String(name||"")
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/\s+/g," ").trim().toLowerCase();
      return n.includes("maria cano"); // tolera variantes
    };

    // ----------- Mapa -----------
    const map = L.map("map", { zoomControl: true });
    const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 20, attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    // Capas base
    const layerBarrio = L.geoJSON(null, {
      style: { color: cssVar("--accent2") || "#FF7043", weight: 2.5, fillOpacity: 0.08 }
    }).addTo(map);

    const layerRutasAll = L.geoJSON(null, {
    style: () => ({ color: "#800080", weight: 2 })
    }).addTo(map);


    const clusterParaderosAll = L.markerClusterGroup({ disableClusteringAtZoom: 17 });

    // Capas destacadas (intersección)
    const layerRutasHit = L.geoJSON(null, {
      style: { color: cssVar("--accent") || "#4FC3F7", weight: 3.5 }
    });
    const layerParaderosHit = L.geoJSON(null, {
      pointToLayer: (_, latlng) => L.circleMarker(latlng, {
        radius: 6, weight: 2, color: "#0b1220",
        fillColor: cssVar("--accent") || "#4FC3F7", fillOpacity: 0.95
      })
    });

    // Popups
    function popupRuta(f, l){
      const p = f.properties || {};
      const nombre = p.NOMBRE || p.name || p.route || "Ruta SITP";
      l.bindPopup(`<b>Ruta SITP</b><br>${nombre}`);
    }
    function popupParadero(f, l){
      const p = f.properties || {};
      const cod = p.CODIGO || p.codigo || p.code || "";
      const nom = p.NOMBRE || p.nombre || p.name || "Paradero";
      l.bindPopup(`<b>Paradero SITP</b><br>${nom}${cod ? "<br><small>"+cod+"</small>" : ""}`);
    }

    // ----------- Carga y lógica -----------
    Promise.all([
      fetch(FILES.barrios).then(r=> r.ok ? r.json() : Promise.reject(new Error("No se pudo leer barrios.geojson"))),
      fetch(FILES.rutasSITP).then(r=> r.ok ? r.json() : Promise.reject(new Error("No se pudo leer Lineas_Estaciones_SITP.geojson"))),
      fetch(FILES.paraderos).then(r=> r.ok ? r.json() : Promise.reject(new Error("No se pudo leer paraderos_zonalesSITP.geojson")))
    ]).then(([barrios, rutas, paraderos]) => {
      // 1) Encontrar María Cano por 'barriocomu'
      const featsBarrio = (barrios.features || []).filter(f => {
        const props = f.properties || {};
        const name = props.barriocomu || props.BARRIO || props.Nombre || props.NOMBRE || props.name;
        return isMariaCano(name);
      });

      if(!featsBarrio.length){
        document.getElementById("resumen").innerHTML =
          `<span class="error">No se encontró el polígono del barrio “María Cano”.</span><br>
           Verifica que <code>barrios.geojson</code> tenga la propiedad <code>barriocomu</code> con ese valor.`;
        map.setView([4.711, -74.072], 11); // Bogotá
        // Muestra totales como referencia
        layerRutasAll.addData(rutas).eachLayer((l)=> popupRuta(l.feature, l));
        L.geoJSON(paraderos, {
          pointToLayer: (_, latlng) => L.circleMarker(latlng, {
            radius: 4, weight:1.5, color:"#0b1220",
            fillColor: cssVar("--baseStops") || "#b0c4de", fillOpacity:0.9
          }),
          onEachFeature: popupParadero
        }).eachLayer(m=>clusterParaderosAll.addLayer(m));
        map.addLayer(clusterParaderosAll);
        return;
      }

      const barrio = featsBarrio[0];
      layerBarrio.addData(barrio);

      // Centrar mapa en el barrio
      const bbox = turf.bbox(barrio);
      map.fitBounds([[bbox[1], bbox[0]], [bbox[3], bbox[2]]], { padding:[20,20] });

      // 2) Pintar totales
      layerRutasAll.addData(rutas).eachLayer((l)=> popupRuta(l.feature, l));
      L.geoJSON(paraderos, {
        pointToLayer: (_, latlng) => L.circleMarker(latlng, {
          radius: 4, weight:1.5, color:"#0b1220",
          fillColor: cssVar("--baseStops") || "#b0c4de", fillOpacity:0.9
        }),
        onEachFeature: popupParadero
      }).eachLayer(m=>clusterParaderosAll.addLayer(m));
      map.addLayer(clusterParaderosAll);

      // 3) Intersecciones (SITP)
      const rutasHits = (rutas.features || []).filter(f => {
        try { return f.geometry && turf.booleanIntersects(f, barrio); }
        catch(e) { return false; }
      });

      let paraderosHits = [];
      try {
        const ptsFC = { type:"FeatureCollection", features: (paraderos.features || []) };
        const dentro = turf.pointsWithinPolygon(ptsFC, barrio);
        paraderosHits = dentro.features || [];
      } catch(e) { paraderosHits = []; }

      // Pintar capas destacadas
      layerRutasHit.addData({ type:"FeatureCollection", features: rutasHits })
                   .eachLayer((l)=> popupRuta(l.feature, l));
      layerParaderosHit.addData({ type:"FeatureCollection", features: paraderosHits })
                        .eachLayer((l)=> popupParadero(l.feature, l));

      // 4) Panel resumen
      const rN = rutas.features?.length ?? 0;
      const pN = paraderos.features?.length ?? 0;
      const rH = rutasHits.length;
      const pH = paraderosHits.length;

      const resumen = document.getElementById("resumen");
      if(rH===0 && pH===0){
        resumen.innerHTML =
          `<div class="warn">El barrio no cuenta con estaciones ni rutas SITP.</div>
           <div class="msg">Se muestran <span class="count">${rN}</span> rutas y <span class="count">${pN}</span> paraderos totales como referencia.</div>`;
      }else{
        resumen.innerHTML =
          `<div>Intersecciones encontradas:</div>
           <ul class="list">
             <li>Rutas dentro del barrio: <span class="count ok">${rH}</span> / ${rN}</li>
             <li>Paraderos dentro del barrio: <span class="count ok">${pH}</span> / ${pN}</li>
           </ul>
           <div class="msg msg-compact">Usa los botones para resaltar solo lo que intersecta.</div>`;
        layerRutasHit.addTo(map);
        layerParaderosHit.addTo(map);
      }

      // 5) Botones
      document.getElementById("btn-zoom-barrio").onclick = () => {
        const b = turf.bbox(barrio);
        map.fitBounds([[b[1], b[0]], [b[3], b[2]]], { padding:[20,20] });
      };
      document.getElementById("btn-ver-intersectan").onclick = () => {
        map.addLayer(layerRutasHit);
        map.addLayer(layerParaderosHit);
      };
      document.getElementById("btn-ver-todo").onclick = () => {
        map.removeLayer(layerRutasHit);
        map.removeLayer(layerParaderosHit);
      };

      // 6) Control de capas
      const overlays = {
        "Barrio María Cano": layerBarrio,
        "Rutas SITP (todas)": layerRutasAll,
        "Paraderos SITP (todos)": clusterParaderosAll,
        "Rutas dentro del barrio": layerRutasHit,
        "Paraderos dentro del barrio": layerParaderosHit
      };
      L.control.layers({ "OpenStreetMap": osm }, overlays, { collapsed:true }).addTo(map);

    }).catch(err=>{
      console.error(err);
      document.getElementById("resumen").innerHTML =
        `<span class="error">Error cargando archivos GeoJSON. Revisa rutas en <code>src/assets/</code>.</span><br><small>${err.message}</small>`;
      map.setView([4.711, -74.072], 11);
    });

    // Dropdown accesible para móvil/táctil
    const btn = document.querySelector('.dropbtn');
    if (btn) {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const dd = btn.closest('.dropdown');
        const expanded = btn.getAttribute('aria-expanded') === 'true';
        btn.setAttribute('aria-expanded', String(!expanded));
        dd.classList.toggle('open');
      });
    }
  });
  </script>
</body>
</html>
